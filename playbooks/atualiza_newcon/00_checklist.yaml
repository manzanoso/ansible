- name: Windows Feature
  hosts: win
  gather_facts: false
  tasks:
    ## Criar estrutura de diretorios
    - name: Criar estrutura de diretorios
      ansible.windows.win_file:
        path: C:\Newcon_Deploy\
        state: directory      
    #  when: 0 > 1
   
    ## Download do pacote de versão
    - name: Download do pacote da versao
      ansible.windows.win_get_url:
        url: https://www4.newconsoftware.com.br/teste/SCRIPT_004_030_SEQ_000003.zip
        dest: C:\Newcon_Deploy\Releases\SCRIPT_004_030_SEQ_000003.zip
    #  when: 0 > 1

    ## Descompactar pacote
    - name: Descompactar pacote
      community.windows.win_unzip:
        src: C:\Newcon_Deploy\Releases\SCRIPT_004_030_SEQ_000003.zip
        dest: C:\Newcon_Deploy\Releases\
        delete_archive: yes
    #  when: 0 > 1

    ## Verifica programas abertos a partir do diretorio com os executaveis do pacote
    - name: Verificar programas abertos
      win_shell: |
        $programas = Get-ChildItem -Path "C:\Newcon_Deploy\Releases\Bin_Sch_Conins\*.exe" | Where-Object {! $_.PSIsContainer} | ForEach-Object { $_.Name -replace '\.\w+$' } | Where-Object { $_ -match '\S' }
        $programasAbertos = @()
        foreach ($programa in $programas) {
            $processo = Get-Process -Name $programa -ErrorAction SilentlyContinue
            if ($processo) {
                $programasAbertos += $programa
            }
        }
        $programasAbertos
      register: programas_abertos

    ## Exibe os programas abertos
    - name: Exibir programas abertos
      debug:
        msg: "Os seguintes programas estão abertos: {{ programas_abertos.stdout }}"
      when: programas_abertos.stdout | length > 0

    ## Caso tenha programa aberto finaliza o processo com falha
    - name: Abend em caso de arquivo aberto
      fail:
      when: programas_abertos.stdout | length > 0