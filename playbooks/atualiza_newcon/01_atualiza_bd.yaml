- name: Windows Feature
  hosts: db
  vars_files:
    - vars/variaveis.yaml   
  gather_facts: false
  tasks:
    - name: Ler o arquivo com a saída registrada
      slurp:
        path: '{{ dir_newcon_deploy }}\file.tmp'
      register: dir_pacote  

    - name: Exibir a saída lida do arquivo
      debug:
        msg: "{{ dir_pacote.stdout }}"      
    
    ####################################################
    ## Valida se tem script de BD
    ####################################################
    - name: Valida se tem Script de BD
      win_find:
        paths: '{{ dir_newcon_deploy }}\Releases\'
        patterns: "*.ver"
      register: exists_script_db

    - name: Criar link simbólico para o arquivo
      file:
        src: '{{ dir_newcon_deploy }}\Releases\{{ dir_pacote.stdout }}\Script_BD\SCRIPT_004_030_SEQ_000003.VER'
        dest: '{{ dir_newcon_deploy }}\Releases\SCRIPT_004_030_SEQ_000003.VER'
        state: link      

    ## Se tiver script atualiza
    - name: Atualizar Script de BD
      win_shell: |
        $resultado = {{ dir_newcon_deploy }}\atualiza_script.ps1
      register: script_process    
      when: exists_script_db.matched > 10000

    ## Valida se o script foi processado com sucesso
    - name: Valida se o script de BD foi atualizado com sucesso
      fail:
      when: script_process.stdout != 'Processo finalizado com sucesso\n'      

